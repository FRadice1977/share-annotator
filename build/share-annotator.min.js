var _ref,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Annotator.Plugin.Share=(function(b){__extends(a,b);function a(){_ref=a.__super__.constructor.apply(this,arguments);return _ref}a.prototype.field=null;a.prototype.input=null;a.prototype.pluginInit=function(){console.log("Share-pluginInit");if(!Annotator.supported()){return}this.field=this.annotator.editor.addField({type:"input",});var d=Annotator.$('<li class="annotator-item">'+this.buildHTML("Share without saving:")+"</li>");Annotator.$(this.field).replaceWith(d);this.field=d[0];this.buttonsActions(this.field,2);var e=this.initAPI();this.runAPI(e);var c=this.annotator.viewer.addField({load:this.updateViewer,buildHTML:this.buildHTML,buttonsActions:this.buttonsActions,createAPIURL:this.createAPIURL,annotator:this.annotator,getSource:this.getSource,});return this.input=$(this.field).find(":input")};a.prototype.buildHTML=function(c){var c=c||"Share:";titleText='<div class="share-text-annotator">'+c+"</div>",facebook='<div class="share-facebook-annotator share-button"></div>',twitter='<div class="share-twitter-annotator share-button"></div>',google='<div class="share-google-annotator share-button"></div>',email='<div class="share-email-annotator share-button"></div>',buttons=facebook+twitter+google+email;return'<div class="share-container-annotator">'+titleText+buttons+"</div>"};a.prototype.buttonsActions=function(d,e){var c=this;$(d).find(".share-email-annotator").click(function(){var f=c.createAPIURL(e),g="Sharing a annotation with Open Video Annotation";body=encodeURIComponent(f);window.open("mailto:?subject="+g+"&body="+body)});$(d).find(".share-facebook-annotator").click(function(){var f=c.createAPIURL(e),g="https://www.facebook.com/sharer/sharer.php?s=100&p[url]="+encodeURIComponent(f)+"&p[title]="+encodeURIComponent("Open Video Annotation")+"&p[summary]="+c.getSource("ovaText");window.open(g)});$(d).find(".share-twitter-annotator").click(function(){var g=c.createAPIURL(e),f="https://twitter.com/intent/tweet?original_referer="+encodeURIComponent(g)+"&source=tweetbutton&url="+encodeURIComponent(g)+"&via=OpenVideoAnnotation&text="+encodeURIComponent("I want to share the next Open Video Annotation: ");window.open(f)});$(d).find(".share-google-annotator").click(function(){var f=c.createAPIURL(e),g="https://plus.google.com/share?url="+encodeURIComponent(f);window.open(g)})};a.prototype.createAPIURL=function(c){var e=this.annotator,i=e.editor,c=c||1,d=window.location.href;if(d.indexOf("?")>=0){d+="&"}else{d+="?"}if(c===1){var n=this.getSource("ovaId");d+="ovaId="+n}else{if(c===2){var k=this.getSource("ovaStart"),l=this.getSource("ovaEnd"),f=this.getSource("ovaText");d+="ovaStart="+k+"&ovaEnd="+l+"&ovaText="+f;if(typeof i.VideoJS!="undefined"&&i.VideoJS!==-1){var g=this.getSource("ovaContainer"),h=this.getSource("ovaSrc");d+="&ovaContainer="+g+"&ovaSrc="+h}else{var j=this.getSource("ovastartOffset"),m=this.getSource("ovaendOffset");d+="&ovastartOffset="+j+"&ovaendOffset="+m}}}return d};a.prototype.getSource=function(f){var f=f||"";if(f=="ovaId"){var h=this.annotator,g=h.viewer,d=$(g.element).find("textarea")[0];f=this.annotation.id}else{var h=this.annotator,e=h.editor,d=$(e.element).find("textarea")[0];if(f=="ovaText"){f=d.value}if(typeof e.VideoJS!="undefined"&&e.VideoJS!==-1){if(f=="ovaContainer"){f=e.VideoJS}else{if(f=="ovaSrc"){f=h.mplayer[e.VideoJS].tag.currentSrc}else{if(f=="ovaStart"){f=h.mplayer[e.VideoJS].rangeslider.getValues().start}else{if(f=="ovaEnd"){f=h.mplayer[e.VideoJS].rangeslider.getValues().end}}}}}else{var c=e.annotation;if(f=="ovastartOffset"){f=c.ranges[0].startOffset}else{if(f=="ovaendOffset"){f=c.ranges[0].endOffset}else{if(f=="ovaStart"){f=c.ranges[0].start}else{if(f=="ovaEnd"){f=c.ranges[0].end}}}}}}return encodeURIComponent(f)};a.prototype.initAPI=function(){console.log("initAPI");var f={},l=this.getParameterByName("ovaId"),e=this.getParameterByName("ovaStart"),g=this.getParameterByName("ovaEnd"),d=this.getParameterByName("ovaContainer"),c=this.getParameterByName("ovaSrc"),k=this.getParameterByName("ovaText"),h=this.getParameterByName("ovaUser"),i=this.getParameterByName("ovastartOffset"),j=this.getParameterByName("ovaendOffset");if(l!=""){$.extend(f,{method:1,ovaId:l})}if(e!=""&&g!=""&&d!=""&&c!=""){$.extend(f,{method:2,start:e,end:g,container:d,src:c,text:k,user:h})}else{if(e!=""&&g!=""&&i!=""&&j!=""){$.extend(f,{method:2,start:e,end:g,startOffset:i,endOffset:j,text:k,user:h})}}return f};a.prototype.runAPI=function(d){var c=this;this.annotator.subscribe("annotationsLoaded",function(e){console.log("runningAPI");var k=$(".annotator-wrapper").parent()[0],h;$.data(k,"annotator",c.annotator);annotator=window.annotator=$.data(k,"annotator");h=typeof annotator.mplayer!="undefined"?annotator.mplayer:[];if(typeof d!="undefined"&&typeof d.method!="undefined"&&(d.method=="1"||d.method=="2")){if(d.method=="1"){var n=annotator.plugins.Store.annotations,o=decodeURIComponent(d.ovaId);for(var v in n){var s=n[v];if(typeof s.id!="undefined"&&s.id==o){if(c._isVideo(s)){if(typeof h[s.target.container]!="undefined"){var t=h[s.target.container];if(t.id_==s.target.container){var x=s;videojs(t.id_).ready(function(){if(t.techName!="Youtube"){t.preload("auto")}t.autoPlayAPI=x;t.play()})}}}else{var r=typeof s.ranges!="undefined"&&typeof s.ranges[0]!="undefined",u=r?s.ranges[0].startOffset:"",j=r?s.ranges[0].endOffset:"";if(typeof u!="undefined"&&typeof j!="undefined"){$(s.highlights).addClass("api");$("html,body").animate({scrollTop:$(s.highlights[0]).offset().top},"slow")}}}}}else{if(d.method=="2"){if(typeof h!="undefined"){var p=decodeURIComponent(d.container),t=h[p],w=(typeof t!="undefined"&&p==t.id_),q=(!isNaN(parseFloat(d.start))&&isFinite(d.start)&&!isNaN(parseFloat(d.end))&&isFinite(d.end)),f=false;if(w){var m=decodeURIComponent(d.src),g=m.substring(0,m.lastIndexOf(".")),l=t.tag.src==""?t.tag.currentSrc:t.tag.src;l=l.substring(0,l.lastIndexOf("."));f=(g==l)}if(w&&q&&f){var i={rangeTime:{start:d.start,end:d.end},created:new Date().toISOString(),updated:new Date().toISOString(),target:{container:p,src:m},media:"video",text:decodeURIComponent(d.text),user:decodeURIComponent(d.user)};videojs(t.id_).ready(function(){t.preload("auto");t.play();t.autoPlayAPI=i})}}var u=d.startOffset,j=d.endOffset;if(!w&&typeof u!="undefined"&&typeof j!="undefined"){var i={ranges:[{start:decodeURIComponent(d.start),end:decodeURIComponent(d.end),startOffset:decodeURIComponent(d.startOffset),endOffset:decodeURIComponent(d.endOffset),}],created:new Date().toISOString(),updated:new Date().toISOString(),media:"text",text:decodeURIComponent(d.text),user:decodeURIComponent(d.user)};annotator.setupAnnotation(i);$(i.highlights).addClass("api");$("html,body").animate({scrollTop:$(i.highlights[0]).offset().top},"slow")}}}}annotator.isShareLoaded=true;annotator.publish("shareloaded")})};a.prototype._isVideo=function(c){var c=c||{};rt=c.rangeTime,isVideo=(typeof c.media!="undefined"&&c.media=="video"),hasContainer=(typeof c.target!="undefined"&&typeof c.target.container!="undefined"),isNumber=(typeof rt!="undefined"&&!isNaN(parseFloat(rt.start))&&isFinite(rt.start)&&!isNaN(parseFloat(rt.end))&&isFinite(rt.end));return(isVideo&&hasContainer&&isNumber)};a.prototype.getParameterByName=function(c){c=c.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+c+"=([^&#]*)"),d=e.exec(location.search);return d==null?"":decodeURIComponent(d[1].replace(/\+/g," "))};a.prototype.updateViewer=function(f,c){var d=this,f=$(f),e=f.addClass("share-viewer-annotator").html(function(){var g;return d.buildHTML()});this.annotation=c;this.buttonsActions(f[0],1);return e};return a})(Annotator.Plugin);