var _ref,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Annotator.Plugin.Share=(function(b){__extends(a,b);a.prototype.options={shareIn:["facebook","twitter","email","google"],getUrl:{facebook:function(e,d,c){return"https://www.facebook.com/sharer/sharer.php?s=100&p[url]="+d+"&p[title]="+encodeURIComponent("Open Video Annotation")+"&p[summary]="+c},twitter:function(e,d,c){return"https://twitter.com/intent/tweet?original_referer="+d+"&source=tweetbutton&url="+d+"&via=OpenVideoAnnotation&text="+encodeURIComponent("I want to share the next Open Video Annotation: ")},google:function(e,d,c){return"https://plus.google.com/share?url="+d},email:function(e,d,c){return"mailto:?subject="+e+"&body="+d}},};function a(d,c){if(typeof c!="undefined"){this.options.shareIn=typeof c.shareIn!="undefined"?c.shareIn:this.options.shareIn}this.buildHTMLShareButton=__bind(this.buildHTMLShareButton,this);this.updateViewer=__bind(this.updateViewer,this);_ref=a.__super__.constructor.apply(this,arguments);return _ref}a.prototype.field=null;a.prototype.input=null;a.prototype.pluginInit=function(){console.log("Share-pluginInit");if(!Annotator.supported()){return}this.field=this.annotator.editor.addField({type:"input",});var d=Annotator.$('<li class="annotator-item">'+this.buildHTMLShareButton("Share without saving:")+"</li>");Annotator.$(this.field).replaceWith(d);this.field=d[0];this.buttonsActions(this.field,2);var e=this.initAPI();this.runAPI(e);var c=this.annotator.viewer.addField({load:this.updateViewer,});return this.input=$(this.field).find(":input")};a.prototype.buildHTMLShareButton=function(f,g){var f=f||"Share:",g=typeof g!="undefined"?'annotationId="'+g+'"':"",d='<div class="share-text-annotator">'+f+"</div>",e='<div class="share-button-annotator share-button" '+g+"></div>",c='<div class="share-popup-overlay-bg" style="z-index:30000000000"><div class="share-popup"><div class="share-popup-items"></div><div class="close-btn">Close</div></div></div>';return'<div class="share-container-annotator">'+d+e+c+"</div>"};a.prototype.buildHTMLPopup=function(f){var e="";if(typeof this.options.shareIn!="undefined"){this.options.shareIn.forEach(function(h){e+='<div class="share-'+h+'-annotator share-button">'+h.charAt(0).toUpperCase()+h.slice(1)+"</div>"})}this.uri=typeof this.uri!="undefined"?this.uri:"";var f='<div class="share-popup-title">'+f.replace(":","")+"</div>",g='<div class="share-popup-copy">Copy and Share:</div>',d='<input type="text" class="share-popup-uri" onclick="javascript:this.select();" readonly="true" value="'+this.uri+'">',c=f+e+g+d;return c};a.prototype.buttonsActions=function(d,e){var c=this;$(d).find(".close-btn").click(function(){$(".share-popup-overlay-bg").hide()});$(d).find(".share-popup-overlay-bg").click(function(){$(".share-popup-overlay-bg").hide()});$(d).find(".share-popup").click(function(){return false});$(d).find(".share-button-annotator.share-button").click(function(){event.preventDefault();var g=this,f=$(this).attr("annotationId"),h=e==1?"Share":"Share without saving";c.uri=c.createAPIURL(e,f);$(this).parent().find(".share-popup-overlay-bg").show();$(this).parent().find(".share-popup-items").html(c.buildHTMLPopup(h));if(typeof c.options.shareIn!="undefined"){c.options.shareIn.forEach(function(i){$(g).parent().find(".share-"+i+"-annotator.share-button").click(function(){var k=c.createAPIURL(e,f),m="Sharing a annotation with Open Video Annotation";link=encodeURIComponent(k),noteText=c.getSource("ovaText"),finalUrl="";if(e==1){var l=c.annotator.viewer,j=$(l.element).find("div:first").html();noteText=encodeURIComponent(j)}finalUrl=typeof c.options.getUrl[i]!="undefined"?c.options.getUrl[i](m,link,noteText):"";if(typeof c.options.getUrl[i]!="undefined"){window.open(finalUrl)}})})}})};a.prototype.createAPIURL=function(c,n){var e=this.annotator,i=e.editor,c=c||1,d=window.location.href;if(d.indexOf("?")>=0){d+="&"}else{d+="?"}if(c===1){var n=typeof n!="undefined"?n:"";d+="ovaId="+n}else{if(c===2){var k=this.getSource("ovaStart"),l=this.getSource("ovaEnd"),f=this.getSource("ovaText");d+="ovaStart="+k+"&ovaEnd="+l+"&ovaText="+f;if(typeof i.VideoJS!="undefined"&&i.VideoJS!==-1){var g=this.getSource("ovaContainer"),h=this.getSource("ovaSrc");d+="&ovaContainer="+g+"&ovaSrc="+h}else{var j=this.getSource("ovastartOffset"),m=this.getSource("ovaendOffset");d+="&ovastartOffset="+j+"&ovaendOffset="+m}}}return d};a.prototype.getSource=function(f){var f=f||"";if(f=="ovaId"){f=this.annotation.id}else{var g=this.annotator,e=g.editor,d=$(e.element).find("textarea")[0];if(f=="ovaText"){f=d.value}if(typeof e.VideoJS!="undefined"&&e.VideoJS!==-1){if(f=="ovaContainer"){f=e.VideoJS}else{if(f=="ovaSrc"){f=g.mplayer[e.VideoJS].tech.options_.source.src}else{if(f=="ovaStart"){f=g.mplayer[e.VideoJS].rangeslider.getValues().start}else{if(f=="ovaEnd"){f=g.mplayer[e.VideoJS].rangeslider.getValues().end}}}}}else{var c=e.annotation;if(f=="ovastartOffset"){f=c.ranges[0].startOffset}else{if(f=="ovaendOffset"){f=c.ranges[0].endOffset}else{if(f=="ovaStart"){f=c.ranges[0].start}else{if(f=="ovaEnd"){f=c.ranges[0].end}}}}}}return encodeURIComponent(f)};a.prototype.initAPI=function(){console.log("initAPI");var f={},m=this.getParameterByName("ovaId"),e=this.getParameterByName("ovaStart"),g=this.getParameterByName("ovaEnd"),d=this.getParameterByName("ovaContainer"),c=this.getParameterByName("ovaSrc"),l=this.getParameterByName("ovaText"),h=this.getParameterByName("ovaUser"),i=this.getParameterByName("ovastartOffset"),j=this.getParameterByName("ovaendOffset");var k=top.location.href;if(m!=""){k=this.removeVariableFromURL(k,"ovaId")}if(e!=""){k=this.removeVariableFromURL(k,"ovaStart")}if(g!=""){k=this.removeVariableFromURL(k,"ovaEnd")}if(d!=""){k=this.removeVariableFromURL(k,"ovaContainer")}if(c!=""){k=this.removeVariableFromURL(k,"ovaSrc")}if(l!=""){k=this.removeVariableFromURL(k,"ovaText")}if(h!=""){k=this.removeVariableFromURL(k,"ovaUser")}if(i!=""){k=this.removeVariableFromURL(k,"ovastartOffset")}if(j!=""){k=this.removeVariableFromURL(k,"ovaendOffset")}window.history.pushState("object or string","Title",k);if(m!=""){$.extend(f,{method:1,ovaId:m})}if(e!=""&&g!=""&&d!=""&&c!=""){$.extend(f,{method:2,start:e,end:g,container:d,src:c,text:l,user:h})}else{if(e!=""&&g!=""&&i!=""&&j!=""){$.extend(f,{method:2,start:e,end:g,startOffset:i,endOffset:j,text:l,user:h})}}return f};a.prototype.runAPI=function(d){var c=this;this.annotator.subscribe("annotationsLoaded",function(e){console.log("runningAPI");var k=$(".annotator-wrapper").parent()[0],h;$.data(k,"annotator",c.annotator);annotator=window.annotator=$.data(k,"annotator");h=typeof annotator.mplayer!="undefined"?annotator.mplayer:[];if(typeof d!="undefined"&&typeof d.method!="undefined"&&(d.method=="1"||d.method=="2")){if(d.method=="1"){var n=annotator.plugins.Store.annotations,o=decodeURIComponent(d.ovaId);for(var v in n){var s=n[v];if(typeof s.id!="undefined"&&s.id==o){if(c._isVideo(s)){if(typeof h[s.target.container]!="undefined"){var t=h[s.target.container];if(t.id_==s.target.container){var x=s;videojs(t.id_).ready(function(){if(t.techName!="Youtube"){t.preload("auto")}t.autoPlayAPI=x;t.play()})}}}else{var r=typeof s.ranges!="undefined"&&typeof s.ranges[0]!="undefined",u=r?s.ranges[0].startOffset:"",j=r?s.ranges[0].endOffset:"";if(typeof u!="undefined"&&typeof j!="undefined"){$(s.highlights).addClass("api");$("html,body").animate({scrollTop:$(s.highlights[0]).offset().top},"slow")}}}}}else{if(d.method=="2"){if(typeof h!="undefined"){var p=decodeURIComponent(d.container),t=h[p],w=(typeof t!="undefined"&&p==t.id_),q=(!isNaN(parseFloat(d.start))&&isFinite(d.start)&&!isNaN(parseFloat(d.end))&&isFinite(d.end)),f=false;if(w){var m=decodeURIComponent(d.src),g=m.substring(0,m.lastIndexOf(".")),l=t.tech.options_.source.src==""?t.tag.currentSrc:t.tech.options_.source.src;l=l.substring(0,l.lastIndexOf("."));f=(g==l)}if(w&&q&&f){var i={rangeTime:{start:d.start,end:d.end},created:new Date().toISOString(),updated:new Date().toISOString(),target:{container:p,src:m},media:"video",text:decodeURIComponent(d.text),user:decodeURIComponent(d.user)};videojs(t.id_).ready(function(){if(t.techName!="Youtube"){t.preload("auto")}t.autoPlayAPI=i;t.play()})}}var u=d.startOffset,j=d.endOffset;if(!w&&typeof u!="undefined"&&typeof j!="undefined"){var i={ranges:[{start:decodeURIComponent(d.start),end:decodeURIComponent(d.end),startOffset:decodeURIComponent(d.startOffset),endOffset:decodeURIComponent(d.endOffset),}],created:new Date().toISOString(),updated:new Date().toISOString(),media:"text",text:decodeURIComponent(d.text),user:decodeURIComponent(d.user)};annotator.setupAnnotation(i);$(i.highlights).addClass("api");$("html,body").animate({scrollTop:$(i.highlights[0]).offset().top},"slow")}}}}annotator.isShareLoaded=true;annotator.publish("shareloaded")})};a.prototype._isVideo=function(c){var c=c||{};rt=c.rangeTime,isVideo=(typeof c.media!="undefined"&&c.media=="video"),hasContainer=(typeof c.target!="undefined"&&typeof c.target.container!="undefined"),isNumber=(typeof rt!="undefined"&&!isNaN(parseFloat(rt.start))&&isFinite(rt.start)&&!isNaN(parseFloat(rt.end))&&isFinite(rt.end));return(isVideo&&hasContainer&&isNumber)};a.prototype.getParameterByName=function(c){c=c.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+c+"=([^&#]*)"),d=e.exec("?"+window.location.href.split("?")[1]);return d==null?"":decodeURIComponent(d[1].replace(/\+/g," "))};a.prototype.removeVariableFromURL=function(f,d){var c=String(f);var e=new RegExp("\\?"+d+"=[^&]*&?","gi");c=c.replace(e,"?");e=new RegExp("\\&"+d+"=[^&]*&?","gi");c=c.replace(e,"&");c=c.replace(/(\?|&)$/,"");e=null;return c};a.prototype.updateViewer=function(f,c){this.annotation=c;var d=this,f=$(f),e=f.addClass("share-viewer-annotator").html(function(){var g;return d.buildHTMLShareButton("Share:",d.getSource("ovaId"))});this.buttonsActions(f[0],1);return e};return a})(Annotator.Plugin);